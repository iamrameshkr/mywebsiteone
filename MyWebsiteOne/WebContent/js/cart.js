+function(a){"use strict";a(function(){var b={ADD_ITEM_TO_CART:"jcart/checkout_cart/checkInviteCode/product/",CHANGE_ITEM_QUANTITY:"jcart/checkout_cart/updateCartItem",INIT_CART:"_account_get_cart"in window?_account_get_cart:"jcart/index/getcart",CLAIM_INVITE:"jcart/checkout_cart/claimInviteCode",USE_INVITE:"jcart/checkout_cart/ajaxAddProduct",REMOVE_VOUCHER:"jcart/checkout_cart/removeCoupon"},c=".",d=function(){function e(b,c,d){var e=o.find(".cart-step-list");e.find(".step").removeClass("current");var g=e.find("."+b).addClass("current");"invite-list"===b&&f(c),("cart-loaded"===b||"empty"===b)&&(d?(g.find(".voucher-list").html(_.template(a("#cart-voucher-tpl").html(),{variable:"item"})(d)),m(g),g.find(".has-voucher").show(),g.find(".cart-background").hide()):(g.find(".has-voucher").hide(),g.find(".cart-background").show())),("invite-list"===b||"no-invite"===b)&&modules&&modules.offCanvas&&modules.offCanvas.pullInOffCanvas&&modules.offCanvas.pullInOffCanvas(e.parents(".js-off-canvas").eq(0))}function f(b){var c=o.find(".related-invites");c.empty(),c.prev().find("span").text(b.length);for(var d=0;d<b.length;d++){var e=b[d];0===d?e.picked=" picked":"",c.append(_.template(a("#cart-invite-tpl").html(),{variable:"item"})(e))}m(c)}function g(a,b){var c=a.data.items,f=a.data.coupon;o.attr("data-key",a.data.form_key),c&&c.length>0?(o.removeClass("empty"),f?e("cart-loaded",null,f):e("cart-loaded"),"undefined"==typeof b?(d.clear(),d.addItems(c)):(b.hash=c[0].id,b.action=c[0].delAction,d.addItem(b)),j(),q()):(o.addClass("empty"),e("empty",null,f)),i()}function h(){modules&&modules.misc&&modules.misc.spin&&modules.misc.spin.show(o),a.ajax({type:"POST",url:b.INIT_CART,dataType:"json",success:function(a){n=!1;var b=1===a.ret;modules&&modules.misc&&modules.misc.spin&&modules.misc.spin.hide(),b?g(a):modules.misc&&modules.misc.dialog&&modules.misc.dialog.show(a.errMsg)},timeout:3e4,error:function(a,b,c){modules&&modules.misc&&modules.misc.spin&&modules.misc.spin.hide()}})}function i(a){var b="undefined"==typeof a?r():a;modules.header&&modules.header.$element&&modules.header.$element.trigger("cartchange.oneplus",b)}function j(){var b=o.eq(0).find(".cart-item"),d=a.trim(b.eq(0).find(".price .num").text());","===d.charAt(d.length-3)&&(c=",")}function k(a){return a=a.toString().replace(/\s/g,""),a=(a.substr(0,a.length-3)+a.slice(-3).replace(",",".")).replace(/,/,""),a-0}function l(a){var b=a.toString(),d=b.length-2;return b=b.substring(0,d)+c+b.substr(d)}function m(a){for(var b=a.find(".invite-card .card-info .hint time"),c=Date.now(),d=1e3,e=60,f=60*e,g=24*f,h=0;h<b.length;h++){var i=b.eq(h).attr("data-time");"undefined"!=typeof i&&(i-=0,b[h].targetTime=parseInt(i+c/d),clearInterval(b[h].counting),function(a){b[a].counting=setInterval(function(){var c=parseInt(b[a].targetTime-Date.now()/d);c=0>=c?0:c;var h=c%e;c-=h;var h=("00"+h).substr(-2)+"s",i=parseInt(c%f/e);c-=i;var i=("00"+i).substr(-2)+"m ",j=parseInt(c%g/f);c-=j;var j=("00"+j).substr(-2)+"h ",k=parseInt(c/g);k=("00"+k).substr(-2)+"d ",b.eq(a).text(k+j+i+h)},300)}(h))}}var n=!1,o=a(a(".ck-cart-info").length>0?".ck-cart-info":".js-off-canvas.js-cart"),p=o.find(".js-cart-list");m(o),o.on("pullInOffCanvas.oneplus",function(){o.hasClass("empty")&&(n=!0,h())}),o.on("addtocart.oneplus",function(c,d){function f(b,c){modules&&modules.misc&&modules.misc.load&&modules.misc.load.start(),n=!0,a.ajax({type:"POST",url:b,data:c["abstract"],dataType:"json",success:function(b){var d=1===b.ret;modules&&modules.misc&&modules.misc.load&&modules.misc.load.finish(),d?("undefined"==typeof b.data.invites?(h(),function(){c.callback&&c.callback(b)}()):b.data.invites.length<=0?(e("no-invite"),n=!1):(e("invite-list",b.data.invites),n=!1),modules&&modules.offCanvas&&modules.offCanvas.pullInOffCanvas&&modules.offCanvas.pullInOffCanvas(a(".js-off-canvas.js-cart"))):(n=!1,109===b.ret?modules&&modules.offCanvas&&modules.offCanvas.pullInOffCanvas&&modules.offCanvas.pullInOffCanvas(a(".js-off-canvas.js-log-in")):modules.misc&&modules.misc.dialog&&modules.misc.dialog.show(b.errMsg))},timeout:3e4,error:function(a,b,c){modules&&modules.misc&&modules.misc.load&&modules.misc.load.finish()}})}n||(d["abstract"].form_key=o.data().key,a(".related-invites").attr("data-product",d.id),f(b.ADD_ITEM_TO_CART+d.id,d))}),o.on("inputValidated.oneplus",".js-claim-an-invite",function(){var c=a("#invite_section_one").val()+"-"+a("#invite_section_two").val()+"-"+a("#invite_section_three").val()+"-"+a("#invite_section_four").val();modules&&modules.misc&&modules.misc.load&&modules.misc.load.start();var d={};if(modules&&modules.product&&modules.product.collectUserSelection){var f=modules.product.collectUserSelection();d=f["abstract"]}d.invite_code=c,d.productId=a(".related-invites").attr("data-product"),a.ajax({type:"POST",url:b.CLAIM_INVITE,data:d,dataType:"json",success:function(b){var c=1===b.ret;modules&&modules.misc&&modules.misc.load&&modules.misc.load.finish(),c?"undefined"!=typeof b.data.invite&&e("invite-list",b.data.invite):101===b.ret?(a(".wrong-invite .error-msg").text(b.errMsg),e("wrong-invite")):modules.misc&&modules.misc.dialog&&modules.misc.dialog.show(b.errMsg)},timeout:3e4,error:function(a,b,c){modules&&modules.misc&&modules.misc.load&&modules.misc.load.finish()}})}),o.on("tap",".js-back-to-claim",function(){e("no-invite")}),o.on("click",".related-invites .invite-card",function(){var b=a(this),c=b.parents(".related-invites").find(".invite-card");c.removeClass("picked"),b.addClass("picked")}),o.on("click",".js-use-picked-invite",function(c){c.preventDefault(),c.stopPropagation(),modules&&modules.misc&&modules.misc.load&&modules.misc.load.start(),n=!0;var d=a(".related-invites .picked").eq(0),e={};if(modules&&modules.product&&modules.product.collectUserSelection){var f=modules.product.collectUserSelection();e=f["abstract"]}e.prodcutId=a(".related-invites").attr("data-product"),e.inviteId=d.attr("data-id"),a.ajax({type:"POST",url:b.USE_INVITE,data:e,dataType:"json",success:function(a){modules&&modules.misc&&modules.misc.load&&modules.misc.load.finish(),1===a.ret?h():(n=!1,modules.misc&&modules.misc.dialog&&modules.misc.dialog.show(a.errMsg))},timeout:3e4,error:function(){}})}),o.on("click",".js-remove-voucher",function(c){c.preventDefault(),c.stopPropagation();var d=a(this),f=d.parents(".invite-card"),g=d.parents(".step"),h={};h.inviteId=f.find(".invite-code").text().replace(/ /g,"-"),a.ajax({type:"POST",url:b.REMOVE_VOUCHER,data:h,dataType:"json",success:function(a){modules&&modules.misc&&modules.misc.load&&modules.misc.load.finish(),1===a.ret?(g.hasClass("empty")?e("empty"):g.find(".has-voucher").hide(),o.is(".ck-cart-info")&&o.find(".has-voucher").remove()):(n=!1,modules.misc&&modules.misc.dialog&&modules.misc.dialog.show(a.errMsg))},timeout:3e4,error:function(){}})}),o.on("paste","#invite_section_one",function(b){var c=a(this);c.attr("maxlength",1e3),setTimeout(function(){var b=c.val(),b=b.split("-");c.val(""),a("#invite_section_one").val(b[0]?b[0].substr(0,4):""),a("#invite_section_two").val(b[1]?b[1].substr(0,4):""),a("#invite_section_three").val(b[2]?b[2].substr(0,4):""),a("#invite_section_four").val(b[3]?b[3].substr(0,4):"").focus(),c.attr("maxlength",4)},0),c.parents("form").find(".form-control").removeClass("invalid")}),o.on("input",".claim-invite input",function(b){var c=a(this);if(c.val().length>=4){var d=c.parents(".claim-invite").find(":input"),e=d.eq(d.index(this)+1);e.val(""),e.focus()}}),o.on("keydown",".claim-invite input",function(b){var c=a(this);if(c.val().length<=0&&8===b.keyCode){var d=c.parents(".claim-invite").find(":input"),e=d.eq(d.index(this)-1);b.preventDefault(),e.focus()}}),o.on("change",".js-num",function(){var c=a(this),d=c.parents(".cart-item"),e={};e.itemId=d.data().hash,e.qty=c.val(),e.form_key=o.data().key,clearTimeout(c.data().delayRequest),c.data().delayRequest=setTimeout(function(){a.ajax({type:"POST",url:b.CHANGE_ITEM_QUANTITY,data:e,dataType:"json",success:function(a){1===a.ret?(c.attr("disabled",!1),o.removeClass("empty"),c.val(e.qty),q(),i()):(modules.misc&&modules.misc.dialog&&modules.misc.dialog.show(a.errMsg),c.val(c.data().oldValue))},timeout:3e4,error:function(){}})},1e3)}),a(".js-off-canvas.js-cart").on("click",".show-accessory",function(b){a(this).siblings(".item-accessories");a(this).parents(".cart-item").toggleClass("expanded")}),a(".ck-cart-info").on("click",".show-accessory",function(b){var c=a(this),d=c.parents(".cart-item");d.toggleClass("collapsed")}),o.on("click",".item-remove",function(b){var c=a(this),e=c.parents(".cart-item").eq(0);modules&&modules.misc&&modules.misc.load&&modules.misc.load.start(),a.ajax({type:"GET",url:c.data().action,data:{form_key:o.data().key},dataType:"json",success:function(a){modules&&modules.misc&&modules.misc.load&&modules.misc.load.finish(),1===a.ret?(d.removeItem(e),q()):modules.misc&&modules.misc.dialog&&modules.misc.dialog.show(a.errMsg)},timeout:3e4,error:function(){}})});var q=function(){for(var a=o.eq(0).find(".cart-item"),b=0,c=0;c<a.length;c++){var d=a.eq(c).find(".js-num-control .js-num").val()-0;d&&(b+=parseInt(100*k(a.eq(c).find(".price .num").text())*d))}o.find(".total-pay").text(l(b)),o.find(".total-pay").parent("span").find(".unit").text(a.eq(0).find(".price .unit").text())},r=function(){for(var a=0,b=o.eq(0).find(".js-num"),c=0;c<b.length;c++)a+=b.eq(c).val()-0;return a};return{AUTHOR:"Michael",VERSION:"1.0.0",LAST_MODIFIED:"2015-05-09",$element:o,addItems:function(a){for(var b=0;b<a.length;b++)d.addItem(a[b])},addItem:function(b){var c=p.find(">li[data-hash="+b.hash+"]");if(c.length>0){var d=c.find(".js-num-control .js-num");d.val(d.val()-0+1)}else b.qty=b.qty||1,p.append(_.template(a("#cart-item-tpl").html(),{variable:"item"})(b))},removeItem:function(a){a.remove();var b=r();0>=b&&h(),modules.header&&modules.header.$element&&modules.header.$element.trigger("removefromcart.oneplus",b)},clear:function(){o.find(".js-cart-list").empty()}}}();window.modules=window.modules||{},window.modules.cart=d})}(jQuery);